<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DayZ - Territory Master Pro v2.6 (Focus Mode)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; padding: 20px; margin: 0; }
        .container { max-width: 1550px; margin: auto; background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { color: #e74c3c; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .layout { display: flex; gap: 25px; }
        .side { flex: 1; min-width: 0; }
        
        textarea { width: 100%; height: 300px; background: #0a0a0a; color: #00ff00; border: 1px solid #444; padding: 12px; font-family: 'Consolas', monospace; font-size: 11px; border-radius: 5px; }
        .config-panel { background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; height: fit-content; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 11px; color: #e67e22; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        select, input { padding: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; font-size: 13px; }
        
        .btn { width: 100%; padding: 14px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        .btn-parse { background: #8e44ad; color: white; }
        .btn-apply { background: #e74c3c; color: white; }
        .btn-copy { background: #2980b9; color: white; }
        .btn-map { background: #27ae60; color: white; width: auto; padding: 10px 20px; }
        .btn:hover { filter: brightness(1.2); }

        #mapContainer { position: relative; width: 750px; height: 750px; background: #050505; border: 2px solid #444; margin-top: 20px; border-radius: 8px; overflow: hidden; display: none; }
        canvas { cursor: crosshair; width: 100%; height: 100%; }
        #mapTooltip { position: fixed; background: rgba(0,0,0,0.95); color: #fff; padding: 10px; border: 1px solid #e74c3c; border-radius: 5px; pointer-events: none; display: none; font-size: 12px; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .map-coords { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; font-family: monospace; color: #00ff00; border-radius: 4px; border: 1px solid #333; pointer-events: none; }
        .map-legend { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; font-size: 11px; border-radius: 5px; line-height: 1.5; }

        .stats-box { background: #111; border: 1px solid #333; padding: 15px; margin-top: 20px; border-radius: 8px; display: flex; justify-content: space-around; text-align: center; }
        .stat-item b { display: block; font-size: 18px; color: #2ecc71; }
        
        pre { background: #000; padding: 15px; color: #00ff00; border: 1px solid #333; height: 150px; overflow: auto; margin-top: 20px; font-size: 10px; border-radius: 5px; }
        .focus-info { color: #2ecc71; font-size: 0.8em; margin-bottom: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üßü Territory Master Pro v2.6 <span style="font-size: 0.6em; color: #888;">| Focus Mode Active</span></h2>
        <button class="btn btn-map" onclick="toggleMap()">üó∫Ô∏è Afficher / Masquer la Carte</button>
    </div>
    
    <div class="layout">
        <div class="side">
            <label>1. Coller le contenu de zombie_territories.xml</label>
            <textarea id="xmlInput" placeholder="Colle ton fichier ici..."></textarea>
            <button class="btn btn-parse" onclick="analyserFichier()">üîç Analyser & Charger Map</button>
            
            <div id="mapContainer">
                <canvas id="dayzMap"></canvas>
                <div id="mapTooltip"></div>
                <div class="map-coords" id="liveCoords">X: 0 | Z: 0</div>
                <div class="map-legend">
                    <b style="color:#e74c3c">‚óè</b> Militaire (Army)<br>
                    <b style="color:#3498db">‚óè</b> Urbain (City/Village)<br>
                    <b style="color:#f1c40f">‚óè</b> Autre
                </div>
            </div>

            <div class="stats-box">
                <div class="stat-item"><b id="totalStatic">0</b><label>Static Max</label></div>
                <div class="stat-item"><b id="totalDynamic" style="color:#3498db">0</b><label>Dyn. Max</label></div>
                <div class="stat-item"><b id="totalZones" style="color:#e67e22">0</b><label>Zones</label></div>
            </div>
        </div>

        <div class="side config-panel">
            <label>2. R√©glages & Filtrage Map</label>
            <div id="focusMsg" class="focus-info">Mode : Vue Globale</div>
            <div class="grid" style="grid-template-columns: 1fr 1fr;">
                <div class="field"><label>Territoire (Couleur)</label><select id="selectColor" onchange="onColorChange()"></select></div>
                <div class="field"><label>Type de Zombie</label><select id="selectZombieType" onchange="drawMap()"></select></div>
            </div>

            <div class="grid">
                <div class="field"><label>Static Min</label><input type="text" id="smin" value="0"></div>
                <div class="field"><label>Static Max</label><input type="text" id="smax" value="0"></div>
                <div class="field"><label>Rayon (r)</label><input type="text" id="radius" value="80"></div>
                <div class="field"><label>Dynamic Min</label><input type="text" id="dmin" value="5-8"></div>
                <div class="field"><label>Dynamic Max</label><input type="text" id="dmax" value="10-15"></div>
                <div class="field"><label>Offset Doublon (m)</label><input type="number" id="offset" value="3"></div>
            </div>

            <button class="btn btn-apply" onclick="appliquerModifications()">üöÄ Appliquer au groupe</button>
            <button class="btn btn-copy" onclick="copierXML()">üìã Copier le r√©sultat XML</button>
            
            <pre id="output"></pre>
        </div>
    </div>
</div>

<script>
let territoryData = [];
const MAP_SIZE = 15360;

const majorPoints = [
    {n: "NWAF", x: 4500, z: 10300}, {n: "TISY", x: 1700, z: 14000},
    {n: "CHERNO", x: 6500, z: 2500}, {n: "ELECTRO", x: 10500, z: 2300},
    {n: "BEREZINO", x: 12500, z: 9500}, {n: "ZELENO", x: 2500, z: 5200}
];

function toggleMap() {
    const container = document.getElementById('mapContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    if(container.style.display === 'block') drawMap();
}

function parseRange(val) {
    if (typeof val !== "string" || !val.includes("-")) return parseInt(val) || 0;
    const parts = val.split("-").map(p => parseInt(p.trim()));
    return Math.floor(Math.random() * (parts[1] - parts[0] + 1)) + parts[0];
}

function analyserFichier() {
    const xml = document.getElementById('xmlInput').value;
    const territoryRegex = /<territory color="(.*?)">([\s\S]*?)<\/territory>/g;
    territoryData = [];
    let match, options = '<option value="">-- VUE GLOBALE --</option>';
    let globS = 0, globD = 0, zCount = 0;

    while ((match = territoryRegex.exec(xml)) !== null) {
        const color = match[1];
        const zones = [];
        const zRegex = /<zone name="(.*?)" smin="(\d+)" smax="(\d+)" dmin="(\d+)" dmax="(\d+)" x="([\d.-]+)" z="([\d.-]+)" r="([\d.-]+)"\s*\/>/g;
        let zMatch;
        while ((zMatch = zRegex.exec(match[2])) !== null) {
            globS += parseInt(zMatch[3]);
            globD += parseInt(zMatch[5]);
            zCount++;
            zones.push({ name: zMatch[1], smin: zMatch[2], smax: zMatch[3], dmin: zMatch[4], dmax: zMatch[5], x: zMatch[6], z: zMatch[7], r: zMatch[8] });
        }
        territoryData.push({ color, zones });
        options += `<option value="${color}">Groupe ${color} (${zones.length} zones)</option>`;
    }
    document.getElementById('selectColor').innerHTML = options;
    document.getElementById('totalStatic').textContent = globS;
    document.getElementById('totalDynamic').textContent = globD;
    document.getElementById('totalZones').textContent = zCount;
    drawMap();
}

function onColorChange() {
    const selColor = document.getElementById('selectColor').value;
    const msg = document.getElementById('focusMsg');
    if(selColor) {
        msg.textContent = "Mode : Focus sur groupe " + selColor;
        msg.style.color = "#2ecc71";
    } else {
        msg.textContent = "Mode : Vue Globale";
        msg.style.color = "#aaa";
    }
    updateSubFilters();
    drawMap();
}

function drawMap() {
    const canvas = document.getElementById('dayzMap');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const size = canvas.parentElement.clientWidth;
    canvas.width = size; canvas.height = size;

    const selColor = document.getElementById('selectColor').value;
    const selZombie = document.getElementById('selectZombieType').value;

    ctx.fillStyle = "#0a0a0a"; ctx.fillRect(0, 0, size, size);
    ctx.strokeStyle = "#1a1a1a";
    for(let i=0; i<size; i += size/15) {
        ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, size); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(size, i); ctx.stroke();
    }

    territoryData.forEach(group => {
        // FILTRE : Si une couleur est s√©lectionn√©e, on ignore les autres groupes
        if (selColor && group.color !== selColor) return;

        group.zones.forEach(z => {
            // FILTRE : Si un type est s√©lectionn√©, on ignore les autres noms
            if (selZombie && selZombie !== "ALL" && z.name !== selZombie) return;

            const px = (parseFloat(z.x) / MAP_SIZE) * size;
            const py = size - ((parseFloat(z.z) / MAP_SIZE) * size);
            
            ctx.fillStyle = z.name.includes("Army") ? "#e74c3c" : (z.name.includes("City") ? "#3498db" : "#f1c40f");
            
            // Si on est en mode FOCUS, on dessine les points un peu plus gros pour mieux voir
            let radius = (selColor) ? 3 : 1.8;
            ctx.beginPath(); ctx.arc(px, py, radius, 0, Math.PI * 2); ctx.fill();
            
            // Si c'est le focus, on peut ajouter un petit halo
            if(selColor) {
                ctx.strokeStyle = "rgba(255,255,255,0.3)";
                ctx.lineWidth = 0.5;
                ctx.stroke();
            }
        });
    });

    ctx.fillStyle = "#555"; ctx.font = "10px Arial";
    majorPoints.forEach(p => {
        ctx.fillText(p.n, (p.x/MAP_SIZE)*size, size-((p.z/MAP_SIZE)*size));
    });
}

document.getElementById('dayzMap').addEventListener('mousemove', function(e) {
    const canvas = e.target; const rect = canvas.getBoundingClientRect();
    const xPx = e.clientX - rect.left; const yPx = e.clientY - rect.top; const size = canvas.width;
    const dX = Math.round((xPx / size) * MAP_SIZE); const dZ = Math.round(((size - yPx) / size) * MAP_SIZE);
    document.getElementById('liveCoords').textContent = `X: ${dX} | Z: ${dZ}`;
    const tooltip = document.getElementById('mapTooltip');
    let found = false;
    const selColor = document.getElementById('selectColor').value;

    for (let g of territoryData) {
        if (selColor && g.color !== selColor) continue;
        for (let z of g.zones) {
            const px = (z.x / MAP_SIZE) * size; const py = size - ((z.z / MAP_SIZE) * size);
            if (Math.hypot(px - xPx, py - yPx) < 6) {
                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 15) + 'px'; tooltip.style.top = (e.clientY + 15) + 'px';
                tooltip.innerHTML = `<b>${z.name}</b><br>X:${z.x} Z:${z.z}<br>S:${z.smin}-${z.smax} D:${z.dmin}-${z.dmax}`;
                found = true; break;
            }
        }
        if (found) break;
    }
    if (!found) tooltip.style.display = 'none';
});

function updateSubFilters() {
    const group = territoryData.find(g => g.color === document.getElementById('selectColor').value);
    if (!group) {
        document.getElementById('selectZombieType').innerHTML = '<option value="ALL">-- TOUS --</option>';
        return;
    }
    const names = [...new Set(group.zones.map(z => z.name))];
    let opt = '<option value="ALL">-- TOUS DANS CE GROUPE --</option>';
    names.forEach(n => opt += `<option value="${n}">${n}</option>`);
    document.getElementById('selectZombieType').innerHTML = opt;
}

function appliquerModifications() {
    const selColor = document.getElementById('selectColor').value;
    const selZombie = document.getElementById('selectZombieType').value;
    if (!selColor) return alert("Choisis une couleur pour appliquer les modifs !");
    const offsetVal = parseFloat(document.getElementById('offset').value);
    let finalXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>\n<territory-type>\n';
    let posMap = new Map();

    territoryData.forEach(group => {
        finalXml += `    <territory color="${group.color}">\n`;
        group.zones.forEach(zone => {
            let x = parseFloat(zone.x), z = parseFloat(zone.z);
            if (group.color === selColor && (selZombie === "ALL" || zone.name === selZombie)) {
                zone.smin = parseRange(document.getElementById('smin').value);
                zone.smax = parseRange(document.getElementById('smax').value);
                zone.dmin = parseRange(document.getElementById('dmin').value);
                zone.dmax = parseRange(document.getElementById('dmax').value);
                zone.r = parseRange(document.getElementById('radius').value);
            }
            let key = `${x.toFixed(1)}_${z.toFixed(1)}`;
            if (posMap.has(key)) {
                let c = posMap.get(key); x += (offsetVal * c); z += (offsetVal * c);
                posMap.set(key, c + 1);
            } else { posMap.set(key, 1); }
            finalXml += `        <zone name="${zone.name}" smin="${zone.smin}" smax="${zone.smax}" dmin="${zone.dmin}" dmax="${zone.dmax}" x="${x.toFixed(2)}" z="${z.toFixed(2)}" r="${zone.r}"/>\n`;
        });
        finalXml += `    </territory>\n`;
    });
    finalXml += '</territory-type>';
    document.getElementById('output').textContent = finalXml;
    analyserFichier(); 
    alert("Modifications appliqu√©es au groupe !");
}

function copierXML() {
    const t = document.getElementById('output').textContent;
    if(t) { navigator.clipboard.writeText(t); alert("XML Copi√© !"); }
}
</script>
</body>
</html>