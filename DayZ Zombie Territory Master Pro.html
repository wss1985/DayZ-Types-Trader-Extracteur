<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DayZ - Territory Master Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1300px; margin: auto; background: #1e1e1e; padding: 25px; border-radius: 10px; border: 1px solid #333; }
        .layout { display: flex; gap: 20px; }
        .side { flex: 1; }
        textarea { width: 100%; height: 350px; background: #1a1a1a; color: #00ff00; border: 1px solid #444; padding: 10px; font-family: monospace; font-size: 11px; }
        .config-panel { background: #252525; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .field { display: flex; flex-direction: column; margin-bottom: 10px; }
        label { font-size: 0.75em; color: #e67e22; font-weight: bold; margin-bottom: 5px; }
        select, input { padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }
        .btn { width: 100%; padding: 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; text-transform: uppercase; margin-top: 10px; }
        .btn-parse { background: #8e44ad; color: white; }
        .btn-apply { background: #e74c3c; color: white; }
        .stats-box { background: #1a1a1a; border: 1px solid #333; padding: 15px; margin-top: 20px; border-radius: 8px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; }
        .stat-val { font-size: 1.5em; color: #2ecc71; font-weight: bold; }
        pre { background: #000; padding: 15px; color: #00ff00; border: 1px solid #333; min-height: 200px; margin-top: 20px; white-space: pre; font-family: monospace; overflow: auto; }
        .help-text { font-size: 0.7em; color: #888; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üßü Territory Master Pro (Random & Compteur)</h2>
    
    <div class="layout">
        <div class="side">
            <label>1. Fichier Source (zombie_territories.xml)</label>
            <textarea id="xmlInput"></textarea>
            <button class="btn btn-parse" onclick="analyserFichier()">üîç Analyser & Compter</button>
            
            <div class="stats-box">
                <label style="color: #aaa; margin-bottom: 10px; display: block;">üìä Estimation Population Totale (Serveur)</label>
                <div class="stats-grid">
                    <div><div class="stat-val" id="totalStatic">0</div><label>Zombies Statiques</label></div>
                    <div><div class="stat-val" id="totalDynamic" style="color:#3498db">0</div><label>Zombies Dynamiques</label></div>
                </div>
            </div>
        </div>

        <div class="side config-panel">
            <label>2. Modification Cibl√©e</label>
            <div class="field">
                <label>Groupe (Couleur)</label>
                <select id="selectColor" onchange="updateSubFilters()"></select>
            </div>
            <div class="field">
                <label>Type de Zombie</label>
                <select id="selectZombieType"></select>
            </div>

            <div class="grid">
                <div class="field"><label>Static Min</label><input type="text" id="smin" value="2-5"><div class="help-text">Ex: 5 ou 2-5</div></div>
                <div class="field"><label>Static Max</label><input type="text" id="smax" value="6-10"></div>
                <div class="field"><label>Rayon (r)</label><input type="text" id="radius" value="80"></div>
                <div class="field"><label>Dynamic Min</label><input type="text" id="dmin" value="5-8"></div>
                <div class="field"><label>Dynamic Max</label><input type="text" id="dmax" value="10-15"></div>
                <div class="field"><label>Offset Doublon</label><input type="number" id="offset" value="3"></div>
            </div>

            <button class="btn btn-apply" onclick="appliquerModifications()">üöÄ Appliquer & G√©n√©rer</button>
            <button class="btn" style="background:#2980b9; color:white" onclick="navigator.clipboard.writeText(document.getElementById('output').textContent); alert('Copi√© !')">üìã Copier le XML</button>
        </div>
    </div>

    <pre id="output"></pre>
</div>

<script>
let territoryData = [];

function parseRange(val) {
    if (typeof val !== "string" || !val.includes("-")) return parseInt(val) || 0;
    const parts = val.split("-").map(p => parseInt(p.trim()));
    return Math.floor(Math.random() * (parts[1] - parts[0] + 1)) + parts[0];
}

function analyserFichier() {
    const xml = document.getElementById('xmlInput').value;
    const territoryRegex = /<territory color="(.*?)">([\s\S]*?)<\/territory>/g;
    territoryData = [];
    let match, options = '<option value="">-- Choisis un groupe --</option>';
    let globS = 0, globD = 0;

    while ((match = territoryRegex.exec(xml)) !== null) {
        const color = match[1];
        const zones = [];
        const zRegex = /<zone name="(.*?)" smin="(\d+)" smax="(\d+)" dmin="(\d+)" dmax="(\d+)" x="([\d.-]+)" z="([\d.-]+)" r="([\d.-]+)"\s*\/>/g;
        let zMatch;
        while ((zMatch = zRegex.exec(match[2])) !== null) {
            globS += parseInt(zMatch[3]); // On compte le Max pour la s√©curit√© serveur
            globD += parseInt(zMatch[5]);
            zones.push({ name: zMatch[1], smin: zMatch[2], smax: zMatch[3], dmin: zMatch[4], dmax: zMatch[5], x: zMatch[6], z: zMatch[7], r: zMatch[8] });
        }
        territoryData.push({ color, zones });
        options += `<option value="${color}">Couleur ${color} (${zones.length} zones)</option>`;
    }
    document.getElementById('selectColor').innerHTML = options;
    document.getElementById('totalStatic').textContent = globS;
    document.getElementById('totalDynamic').textContent = globD;
}

function updateSubFilters() {
    const group = territoryData.find(g => g.color === document.getElementById('selectColor').value);
    if (!group) return;
    const names = [...new Set(group.zones.map(z => z.name))];
    let opt = '<option value="ALL">-- TOUS DANS CE GROUPE --</option>';
    names.forEach(n => opt += `<option value="${n}">${n}</option>`);
    document.getElementById('selectZombieType').innerHTML = opt;
}

function appliquerModifications() {
    const selColor = document.getElementById('selectColor').value;
    const selZombie = document.getElementById('selectZombieType').value;
    if (!selColor) return alert("Choisis une couleur !");

    const offset = parseFloat(document.getElementById('offset').value);
    let finalXml = '<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>\n<territory-type>\n';
    let globalPositions = new Map();

    territoryData.forEach(group => {
        finalXml += `    <territory color="${group.color}">\n`;
        group.zones.forEach(zone => {
            let x = parseFloat(zone.x), z = parseFloat(zone.z);
            
            if (group.color === selColor && (selZombie === "ALL" || zone.name === selZombie)) {
                zone.smin = parseRange(document.getElementById('smin').value);
                zone.smax = parseRange(document.getElementById('smax').value);
                zone.dmin = parseRange(document.getElementById('dmin').value);
                zone.dmax = parseRange(document.getElementById('dmax').value);
                zone.r = parseRange(document.getElementById('radius').value);
            }

            let posKey = `${x.toFixed(2)}_${z.toFixed(2)}`;
            if (globalPositions.has(posKey)) {
                let count = globalPositions.get(posKey);
                x += (offset * count); z += (offset * count);
                globalPositions.set(posKey, count + 1);
            } else { globalPositions.set(posKey, 1); }

            finalXml += `        <zone name="${zone.name}" smin="${zone.smin}" smax="${zone.smax}" dmin="${zone.dmin}" dmax="${zone.dmax}" x="${x.toFixed(2)}" z="${z.toFixed(2)}" r="${zone.r}"/>\n`;
        });
        finalXml += `    </territory>\n`;
    });

    finalXml += '</territory-type>';
    document.getElementById('output').textContent = finalXml;
    
    // Recalculer les stats apr√®s modif
    let newS = 0, newD = 0;
    const maxMatch = [...finalXml.matchAll(/smax="(\d+)"/g)];
    const dMaxMatch = [...finalXml.matchAll(/dmax="(\d+)"/g)];
    maxMatch.forEach(m => newS += parseInt(m[1]));
    dMaxMatch.forEach(m => newD += parseInt(m[1]));
    document.getElementById('totalStatic').textContent = newS;
    document.getElementById('totalDynamic').textContent = newD;
}
</script>
</body>
</html>